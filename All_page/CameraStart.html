<!DOCTYPE html>
<html>

<head>
  <meta charset="utf8">
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>
  <title>Camera Test</title>
  <style>
    canvas,
    video {
      border: 1px solid gray;
    }
  </style>
  <link rel="stylesheet" href="./css/destyle.css">
  <link rel="stylesheet" href="./css/camera.css">
</head>

<body>


  <!-- camera画面 -->
  <div class="video_wrapper">
    <video id="camera"></video>
  </div>



  <!-- cssで非表示 -->
  <div class="video_wrapper_2">
    <canvas id="picture"></canvas>
  </div>

  <img id="output" src="" alt="">

  <form>
    <button type="button" id="shutter" onclick="buttonClick()">　</button>
  </form>

  <div >
    <a href="./home.html" id="pageback"><img src="./img/Uターン矢印 2.png" alt=""></a>
  </div>

  <form action="./kensho.php" id="form1" method="POST">
    <input type="hidden" id="send_img" name="img" value="">
  </form>

  <!-- <button type="button"  onclick="imgTagButton()">imgタグに表示</button> -->



  <audio id="se" preload="auto">
    <source src="camera-shutter1.mp3" type="audio/mp3">
  </audio>

  <script>
    window.onload = () => {
      const video = document.querySelector("#camera");
      const canvas = document.querySelector("#picture");
      const se = document.querySelector('#se');

      /** カメラ設定 */
      const constraints = {
        audio: false,
        video: {
          // width: 300,
          // height: 200,
          facingMode: "user"   // フロントカメラを利用する
          // facingMode: { exact: "environment" }  // リアカメラを利用する場合
        }
      };

      /**
       * カメラを<video>と同期
       */
      navigator.mediaDevices.getUserMedia(constraints)
        .then((stream) => {
          video.srcObject = stream;
          video.onloadedmetadata = (e) => {
            video.play();
          };
        })
        .catch((err) => {
          console.log(err.name + ": " + err.message);
        });

      /**
       * シャッターボタン
       */
      document.querySelector("#shutter").addEventListener("click", () => {
        const ctx = canvas.getContext("2d");

        // 演出的な目的で一度映像を止めてSEを再生する
        video.pause();
        // se.play();
        // setTimeout(() => {
        //   video.play();    // カメラ再開
        // }, 500);

        // canvasに画像を貼り付ける
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      });
    };

    function buttonClick() {
      var send = document.getElementById('send');
      if (!send) {
        let fragment = document.createDocumentFragment();

        let child1 = document.createElement('a')
        child1.setAttribute('id', 'return')
        child1.setAttribute('href', 'CameraStart.html');
        child1.append(document.createTextNode('撮り直す'));


        let child2 = document.createElement('button');
        child2.setAttribute('id', 'send')
        child2.setAttribute('type', 'submit');
        child2.setAttribute('onclick', 'sendButton()')
        child2.append(document.createTextNode('調べる'));


        fragment.append(child1);
        fragment.append(child2);

        let parentnode = document.getElementById('form1');
        parentnode.append(fragment);
      }


      // const div1 = document.getElementById("div1");
      // const addButton1 = document.createElement('button');
      // addButton1.setAttribute("id","button1");
      // addButton1.textContent = "再撮影";

      // div1.appendChild(addButton1);

      // const form1 = document.getElementById("form1");
      // const addButton2 = document.createElement('button');
      // addButton2.setAttribute("id","button2");
      // addButton2.textContent = "検証";

      // form1.appendChild(addButton2);
    }


    function imgTagButton() {

      // キャンパス要素を取得 (既に描画されている)
      var canvas = document.getElementById("picture");

      // 描画内容をデータURIに変換する (引数なしだとPNG)
      var dataURI = canvas.toDataURL();

      // JPGにする場合 (第2引数は品質)
      var dataURI = canvas.toDataURL("image/jpeg", 0.75);

      // WEBPにする場合 (Chrome以外は非対応なのでPNGになる)
      // var dataURI = canvas.toDataURL( "image/webp", 0.75 ) ;

      // img要素を取得
      var image = document.getElementById("output");

      var sendImg = document.getElementById("send_img");

      sendImg.value = dataURI;

      // データURIは直接img要素のsrc属性に指定できる
      image.src = dataURI;


    }


    function sendButton() {
      // キャンパス要素を取得 (既に描画されている)
      var canvas = document.getElementById("picture");

      // 描画内容をデータURIに変換する (引数なしだとPNG)
      var dataURI = canvas.toDataURL();

      // JPGにする場合 (第2引数は品質)
      var dataURI = canvas.toDataURL("image/jpeg", 0.75);

      // WEBPにする場合 (Chrome以外は非対応なのでPNGになる)
      // var dataURI = canvas.toDataURL( "image/webp", 0.75 ) ;

      // img要素を取得
      var sendImg = document.getElementById("send_img");

      sendImg.value = dataURI;
    }
  </script>


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143297-8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-143297-8');
  </script>






</body>

</html>